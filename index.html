<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¬í˜¸ì˜ ë©”ëª¨ì¥</title>
  <style>
    /* ================================
       ê³µí†µ í°íŠ¸ / ë°•ìŠ¤ ì„¤ì •
       ================================ */
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* ================================
       í…Œë§ˆ ë° ì‚¬ìš©ì ìŠ¤íƒ€ì¼ìš© CSS ë³€ìˆ˜
       ================================ */
    body {
      margin: 0;
      padding: 20px;

      /* ì‚¬ìš©ì ì¡°ì ˆ ê¸°ë³¸ê°’ */
      --font-size-main: 16px;
      --text-main: #e5f5ff;
      --bg-body: #020617;

      /* ê³ ì •ëœ íŒ”ë ˆíŠ¸ (ë‹¤í¬ ê¸°ì¤€)*/
      --sub-text: #a5b4fc;
      --card-bg: rgba(15, 23, 42, 0.97);
      --shadow-color: rgba(15, 23, 42, 0.9);
      --border-color: #1f2937;
      --input-bg: #020617;
      --input-border: #1f2937;
      --meta-text: #64748b;
      --preview-text: #cbd5f5;
      --empty-text: #6b7280;

      --accent: #38bdf8;      /* ë©”ì¸ í¬ì¸íŠ¸ */
      --accent-2: #22c55e;    /* ê·¸ë¼ë””ì–¸íŠ¸ ë³´ì¡° ì»¬ëŸ¬ */
      --accent-hover: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.25);
      --accent-info: #a5f3fc;
      --current-time: #38bdf8;
      --button-secondary-bg: #0b1220;
      --button-secondary-hover: #111827;

      background: radial-gradient(circle at top, #0f172a 0, var(--bg-body) 55%);
      color: var(--text-main);
      font-size: var(--font-size-main);
      transition: background 0.25s, color 0.25s, font-size 0.25s;
    }

    /* ë‹¤í¬ ëª¨ë“œ */
    body.dark-mode {
      --card-bg: rgba(15, 23, 42, 0.97);
      --shadow-color: rgba(15, 23, 42, 0.9);
      --border-color: #1f2937;
    }

    /* ë¼ì´íŠ¸ ëª¨ë“œ */
    body.light-mode {
      --bg-body: #e5f3ff;
      --text-main: #0f172a;
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow-color: rgba(148, 163, 184, 0.5);
      --border-color: #cbd5e1;
      --input-bg: #ffffff;
      --input-border: #cbd5e1;
      --preview-text: #475569;
      --empty-text: #94a3b8;

      --accent: #0ea5e9;
      --accent-2: #22c55e;
      --accent-hover: #0284c7;
      --accent-soft: rgba(14, 165, 233, 0.18);
      --accent-info: #0ea5e9;
      --current-time: #0ea5e9;
      --button-secondary-bg: #e2e8f0;
      --button-secondary-hover: #cbd5e1;

      background: radial-gradient(circle at top, #e0f2fe 0, var(--bg-body) 55%);
    }

    h1 {
      margin-top: 0;
      font-size: calc(var(--font-size-main) * 1.5);
    }

    .sub-text {
      font-size: calc(var(--font-size-main) * 0.85);
      color: var(--sub-text);
      margin-bottom: 8px;
    }

    .current-time {
      font-size: calc(var(--font-size-main) * 0.9);
      color: var(--current-time);
      margin-bottom: 12px;
      text-align: right;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      max-width: 960px;
      margin: 0 auto 4px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    #themeToggle {
      border: none;
      padding: 7px 14px;
      border-radius: 999px;
      font-size: calc(var(--font-size-main) * 0.85);
      cursor: pointer;
      background: var(--button-secondary-bg);
      color: var(--text-main);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    #themeToggle:hover {
      background: var(--button-secondary-hover);
    }

    /* ìŠ¤íƒ€ì¼ íˆ´ë°” */
    .style-toolbar-wrapper {
      max-width: 960px;
      margin: 0 auto;
    }

    .style-toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px;
      font-size: calc(var(--font-size-main) * 0.9);
      text-align: center;
    }

    .style-toolbar label {
      display: flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    .style-toolbar select,
    .style-toolbar input[type="color"] {
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: inherit;
    }

    #styleSaveBtn {
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #ffffff;
      font-size: inherit;
      font-weight: 600;
      margin-top: 4px;
      box-shadow: 0 8px 20px rgba(15, 118, 110, 0.4);
    }

    #styleSaveBtn:hover {
      filter: brightness(1.06);
    }

    /* ì•± ë ˆì´ì•„ì›ƒ */
    .app {
      max-width: 960px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 22px;
      padding: 20px 20px 18px;
      box-shadow: 0 24px 64px var(--shadow-color);
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      backdrop-filter: blur(12px);
    }

    .form-section, .list-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-size: calc(var(--font-size-main) * 0.8);
      font-weight: 600;
    }

    input[type="text"],
    textarea,
    input[type="datetime-local"],
    select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--input-border);
      font-size: var(--font-size-main);
      background: var(--input-bg);
      color: var(--text-main);
      outline: none;
      transition: border-color 0.18s, box-shadow 0.18s, background 0.18s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    textarea {
      min-height: 180px;
      resize: vertical;
    }

    .emoji-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .emoji-preview {
      font-size: calc(var(--font-size-main) * 1.4);
      padding: 4px 8px;
    }

    .template-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: -4px;
      margin-bottom: 2px;
    }

    .template-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 3px 10px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.4);
      color: var(--accent-info);
      cursor: pointer;
    }

    body.light-mode .template-chip {
      background: #e0f2fe;
      color: #0369a1;
    }

    .template-chip:hover {
      background: var(--accent-soft);
    }

    .count-info {
      font-size: 11px;
      color: var(--meta-text);
      text-align: right;
      margin-top: -4px;
      margin-bottom: 4px;
    }

    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      padding: 9px 16px;
      border-radius: 999px;
      font-size: calc(var(--font-size-main) * 0.9);
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .btn-save {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.45);
    }

    .btn-new {
      background: var(--button-secondary-bg);
      color: var(--text-main);
    }

    .btn-save:hover {
      filter: brightness(1.05);
    }

    .btn-new:hover {
      background: var(--button-secondary-hover);
    }

    /* ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ */
    .list-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .search-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: calc(var(--font-size-main) * 0.85);
      outline: none;
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: calc(var(--font-size-main) * 0.75);
      color: var(--meta-text);
      gap: 8px;
    }

    .filter-chip {
      padding: 4px 10px;
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--border-color);
      font-size: inherit;
      color: var(--meta-text);
      cursor: pointer;
    }

    .filter-chip.active {
      background: var(--accent-soft);
      color: var(--accent-info);
      border-color: var(--accent);
    }

    .note-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 0;
      max-height: 360px;
      overflow-y: auto;
    }

    .note-item {
      background: var(--input-bg);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.15s;
    }

    .note-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.5);
      border-color: var(--accent-soft);
    }

    .note-main {
      flex: 1;
      display: flex;
      gap: 10px;
      cursor: pointer;
    }

    .note-emoji {
      font-size: calc(var(--font-size-main) * 1.3);
    }

    .note-texts {
      flex: 1;
      overflow: hidden;
    }

    .note-title {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-bottom: 2px;
    }

    .note-preview {
      font-size: calc(var(--font-size-main) * 0.8);
      color: var(--preview-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note-meta {
      font-size: calc(var(--font-size-main) * 0.7);
      color: var(--meta-text);
      margin-top: 2px;
    }

    .note-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      font-size: calc(var(--font-size-main) * 1.1);
    }

    .icon-btn {
      background: transparent;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border: none;
      cursor: pointer;
      color: var(--preview-text);
    }

    .icon-btn:hover {
      background: rgba(148, 163, 184, 0.18);
    }

    .icon-btn.pin.active {
      color: #facc15;
    }

    .empty-message {
      font-size: calc(var(--font-size-main) * 0.8);
      color: var(--empty-text);
      padding-top: 4px;
    }

    .draft-info {
      color: var(--accent-info);
      font-size: calc(var(--font-size-main) * 0.75);
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: 1fr;
      }
      .current-time {
        text-align: left;
        max-width: 960px;
        margin: 0 auto 12px;
      }
    }
  </style>
</head>

<body>
  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    <div>
      <h1>ì¬í˜¸ì˜ ë©”ëª¨ì¥ ğŸ’ª</h1>
      <div class="sub-text">ë‚®/ë°¤ ëª¨ë“œ Â· ìŠ¤íƒ€ì¼ ì¡°ì ˆ Â· ì•ŒëŒ Â· ìë™ì €ì¥ Â· í•€ Â· í…œí”Œë¦¿</div>
    </div>
    <button id="themeToggle">ğŸŒ™ ë°¤ ëª¨ë“œë¡œ</button>
  </div>

  <div class="style-toolbar-wrapper">
    <!-- ê°€ìš´ë° ì •ë ¬ëœ ìŠ¤íƒ€ì¼ íˆ´ë°” -->
    <div class="style-toolbar">
      <label>
        ê¸€ì í¬ê¸°:
        <select id="fontSizeSelect">
          <option value="14px">ì‘ê²Œ (14px)</option>
          <option value="16px" selected>ê¸°ë³¸ (16px)</option>
          <option value="18px">ì¡°ê¸ˆ í¬ê²Œ (18px)</option>
          <option value="20px">í¬ê²Œ (20px)</option>
          <option value="24px">ì•„ì£¼ í¬ê²Œ (24px)</option>
        </select>
      </label>

      <label>
        ê¸€ì ìƒ‰:
        <input type="color" id="fontColorPicker" value="#e5f5ff" />
      </label>

      <label>
        ë°°ê²½ ìƒ‰:
        <input type="color" id="bgColorPicker" value="#020617" />
      </label>

      <button id="styleSaveBtn">ğŸ’¾ ìŠ¤íƒ€ì¼ ì €ì¥</button>
    </div>
  </div>

  <div id="currentTime" class="current-time"></div>

  <!-- ë©”ì¸ ì•± -->
  <div class="app">
    <!-- ë©”ëª¨ ì…ë ¥ -->
    <section class="form-section">
      <input type="hidden" id="noteId" />

      <label for="title">ì œëª©</label>
      <input type="text" id="title" placeholder="ì˜¤ëŠ˜ì˜ ë‹¤ì§, ìš´ë™ ê³„íš, ê³µë¶€ ëª©í‘œ ë“±ì„ ì ì–´ë³´ì„¸ìš”" />

      <div class="template-chips">
        <button type="button" class="template-chip" data-template="plan">ì˜¤ëŠ˜ ê³„íš í…œí”Œë¦¿</button>
        <button type="button" class="template-chip" data-template="workout">ìš´ë™ ê¸°ë¡ í…œí”Œë¦¿</button>
        <button type="button" class="template-chip" data-template="thanks">ê°ì‚¬ ì¼ê¸° í…œí”Œë¦¿</button>
      </div>

      <label>ê°•ì¸í•œ ì´ëª¨ì§€</label>
      <div class="emoji-row">
        <select id="emojiSelect">
          <option value="ğŸ’ª">ğŸ’ª ê·¼ìœ¡ (íŒŒì´íŒ…)</option>
          <option value="ğŸ”¥" selected>ğŸ”¥ ë¶ˆê½ƒ (ì—´ì •)</option>
          <option value="ğŸ¦">ğŸ¦ ì‚¬ì (ìš©ê¸°)</option>
          <option value="âš¡">âš¡ ë²ˆê°œ (ì§‘ì¤‘ë ¥)</option>
          <option value="ğŸ›¡ï¸">ğŸ›¡ï¸ ë°©íŒ¨ (ë²„í‹°ê¸°)</option>
        </select>
        <span id="emojiPreview" class="emoji-preview">ğŸ”¥</span>
      </div>

      <label for="content">ë‚´ìš©</label>
      <textarea id="content" placeholder="ë©”ëª¨ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”"></textarea>
      <div id="countInfo" class="count-info">0 ê¸€ì Â· 0 ì¤„</div>

      <label for="alarmAt">ì•ŒëŒ (ì„ íƒ)</label>
      <input type="datetime-local" id="alarmAt" />
      <div style="font-size:12px; color:var(--meta-text);">
        ì„¤ì •í•œ ì‹œê°„ì— ë§ì¶° ì•Œë¦¼ ì°½ì´ í•œ ë²ˆ ëœ¹ë‹ˆë‹¤. (ë¸Œë¼ìš°ì €ê°€ ì¼œì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)
      </div>

      <div class="draft-info" id="draftInfo">ìë™ì €ì¥ ëŒ€ê¸° ì¤‘...</div>

      <div class="buttons">
        <button class="btn-save" id="saveBtn">ì €ì¥ (Create / Update)</button>
        <button class="btn-new" id="newBtn">ìƒˆ ë©”ëª¨</button>
      </div>
    </section>

    <!-- ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ -->
    <section class="list-section">
      <div class="list-header">
        <input id="searchInput" class="search-input" placeholder="ë©”ëª¨ ê²€ìƒ‰ (ì œëª©/ë‚´ìš©)" />

        <div class="filter-row">
          <span id="noteCountText">ì´ 0ê°œ ë©”ëª¨</span>
          <button id="pinnedFilterBtn" class="filter-chip">â˜… í•€ ë©”ëª¨ë§Œ ë³´ê¸°</button>
        </div>
      </div>

      <ul id="noteList" class="note-list"></ul>
      <div id="emptyMessage" class="empty-message">ì €ì¥ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”.</div>
    </section>
  </div>

  <script>
    // ===== ìƒìˆ˜ =====
    const STORAGE_KEY = "memo_notes_v2";
    const DRAFT_KEY = "memo_draft_v2";
    const STYLE_KEY = "memo_style_v2";
    const THEME_KEY = "memo_theme_v2";

    // ===== DOM =====
    const bodyEl = document.body;

    const currentTimeEl = document.getElementById("currentTime");

    const fontSizeSelect = document.getElementById("fontSizeSelect");
    const fontColorPicker = document.getElementById("fontColorPicker");
    const bgColorPicker = document.getElementById("bgColorPicker");
    const styleSaveBtn = document.getElementById("styleSaveBtn");
    const themeToggleBtn = document.getElementById("themeToggle");

    const noteIdInput = document.getElementById("noteId");
    const titleInput = document.getElementById("title");
    const contentInput = document.getElementById("content");
    const emojiSelect = document.getElementById("emojiSelect");
    const emojiPreview = document.getElementById("emojiPreview");
    const alarmAtInput = document.getElementById("alarmAt");
    const draftInfo = document.getElementById("draftInfo");
    const countInfo = document.getElementById("countInfo");

    const saveBtn = document.getElementById("saveBtn");
    const newBtn = document.getElementById("newBtn");

    const searchInput = document.getElementById("searchInput");
    const pinnedFilterBtn = document.getElementById("pinnedFilterBtn");
    const noteListEl = document.getElementById("noteList");
    const emptyMessageEl = document.getElementById("emptyMessage");
    const noteCountText = document.getElementById("noteCountText");

    const templateChips = document.querySelectorAll(".template-chip");

    // ===== ìƒíƒœ =====
    let notes = [];
    let showPinnedOnly = false;
    let alarmTimer = null;
    let draftTimer = null;

    // ===== ê³µí†µ ìœ í‹¸ =====
    function nowISO() {
      return new Date().toISOString();
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const h = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${h}:${min}`;
    }

    function relativeTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      const diff = Date.now() - d.getTime();
      if (diff < 0) return "ë°©ê¸ˆ";
      const sec = Math.floor(diff / 1000);
      const min = Math.floor(sec / 60);
      const hour = Math.floor(min / 60);
      const day = Math.floor(hour / 24);
      if (sec < 60) return "ë°©ê¸ˆ ì „";
      if (min < 60) return `${min}ë¶„ ì „`;
      if (hour < 24) return `${hour}ì‹œê°„ ì „`;
      return `${day}ì¼ ì „`;
    }

    // ===== ì‹œê°„ í‘œì‹œ =====
    setInterval(() => {
      currentTimeEl.textContent = "í˜„ì¬ ì‹œê°„: " + formatDateTime(nowISO());
    }, 1000);

    // ===== ìŠ¤íƒ€ì¼ ì ìš© =====
    function applyStyle(fontSize, fontColor, bgColor) {
      if (fontSize) bodyEl.style.setProperty("--font-size-main", fontSize);
      if (fontColor) bodyEl.style.setProperty("--text-main", fontColor);
      if (bgColor) bodyEl.style.setProperty("--bg-body", bgColor);
    }

    function loadStyle() {
      const savedRaw = localStorage.getItem(STYLE_KEY);
      if (!savedRaw) return;
      const savedStyle = JSON.parse(savedRaw);
      const { fontSize, fontColor, bgColor } = savedStyle;
      applyStyle(fontSize, fontColor, bgColor);
      if (fontSize) fontSizeSelect.value = fontSize;
      if (fontColor) fontColorPicker.value = fontColor;
      if (bgColor) bgColorPicker.value = bgColor;
    }

    function saveStyle() {
      const fontSize = fontSizeSelect.value;
      const fontColor = fontColorPicker.value;
      const bgColor = bgColorPicker.value;
      applyStyle(fontSize, fontColor, bgColor);
      localStorage.setItem(STYLE_KEY, JSON.stringify({ fontSize, fontColor, bgColor }));
      alert("ìŠ¤íƒ€ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    styleSaveBtn.addEventListener("click", saveStyle);
    [fontSizeSelect, fontColorPicker, bgColorPicker].forEach(el =>
      el.addEventListener("input", () =>
        applyStyle(fontSizeSelect.value, fontColorPicker.value, bgColorPicker.value)
      )
    );

    // ===== í…Œë§ˆ (ë‚®/ë°¤) =====
    function applyTheme(theme) {
      bodyEl.classList.remove("dark-mode", "light-mode");
      bodyEl.classList.add(`${theme}-mode`);
      themeToggleBtn.textContent = theme === "light" ? "ğŸŒ™ ë°¤ ëª¨ë“œë¡œ" : "â˜€ï¸ ë‚® ëª¨ë“œë¡œ";
      localStorage.setItem(THEME_KEY, theme);
    }

    themeToggleBtn.addEventListener("click", () => {
      const newTheme = bodyEl.classList.contains("dark-mode") ? "light" : "dark";
      applyTheme(newTheme);
    });

    function loadTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY) ||
        (new Date().getHours() >= 18 ? "dark" : "light");
      applyTheme(savedTheme);
    }

    // ===== ë©”ëª¨ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
    function loadNotes() {
      const raw = localStorage.getItem(STORAGE_KEY);
      notes = raw ? JSON.parse(raw) : [];
    }

    function saveNotes() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    }

    // ===== ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ =====
    function updateCountInfo() {
      const text = contentInput.value || "";
      const chars = text.length;
      const lines = text.split(/\r\n|\r|\n/).length;
      countInfo.textContent = `${chars} ê¸€ì Â· ${lines} ì¤„`;
    }

    contentInput.addEventListener("input", updateCountInfo);

    // ===== ë©”ëª¨ ë Œë”ë§ =====
    function renderNotes() {
      noteListEl.innerHTML = "";
      const keyword = searchInput.value.trim().toLowerCase();

      let filtered = notes.slice();

      if (showPinnedOnly) {
        filtered = filtered.filter(n => n.pinned);
      }

      if (keyword) {
        filtered = filtered.filter(n =>
          (n.title || "").toLowerCase().includes(keyword) ||
          (n.content || "").toLowerCase().includes(keyword)
        );
      }

      filtered.sort((a, b) => {
        if (b.pinned === a.pinned) {
          return (b.updatedAt || 0) - (a.updatedAt || 0);
        }
        return Number(b.pinned) - Number(a.pinned);
      });

      noteCountText.textContent = `ì´ ${notes.length}ê°œ ë©”ëª¨`;

      if (filtered.length === 0) {
        emptyMessageEl.style.display = "block";
        return;
      }
      emptyMessageEl.style.display = "none";

      filtered.forEach(note => {
        const li = document.createElement("li");
        li.className = "note-item";

        const main = document.createElement("div");
        main.className = "note-main";

        const emojiSpan = document.createElement("span");
        emojiSpan.className = "note-emoji";
        emojiSpan.textContent = note.emoji || "ğŸ’ª";

        const textsDiv = document.createElement("div");
        textsDiv.className = "note-texts";

        const titleDiv = document.createElement("div");
        titleDiv.className = "note-title";
        titleDiv.textContent = note.title || "ì œëª© ì—†ìŒ";

        const previewDiv = document.createElement("div");
        previewDiv.className = "note-preview";
        const preview = (note.content || "").replace(/\s+/g, " ");
        previewDiv.textContent = preview.slice(0, 40);

        const metaDiv = document.createElement("div");
        metaDiv.className = "note-meta";
        const timeText = note.updatedAt
          ? `${relativeTime(note.updatedAt)} Â· ${formatDateTime(note.updatedAt)}`
          : "";
        const alarmInfo = note.alarmAt && !note.alarmDone ? " Â· â° ì˜ˆì •" :
                          note.alarmAt && note.alarmDone ? " Â· â° ì™„ë£Œ" : "";
        metaDiv.textContent = timeText + alarmInfo;

        textsDiv.appendChild(titleDiv);
        textsDiv.appendChild(previewDiv);
        textsDiv.appendChild(metaDiv);

        main.appendChild(emojiSpan);
        main.appendChild(textsDiv);

        main.addEventListener("click", () => loadNoteIntoForm(note.id));

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "note-actions";

        const pinBtn = document.createElement("button");
        pinBtn.className = "icon-btn pin" + (note.pinned ? " active" : "");
        pinBtn.innerHTML = "â˜…";
        pinBtn.title = "í•€ ê³ ì •";
        pinBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          togglePin(note.id);
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "icon-btn delete";
        deleteBtn.innerHTML = "ğŸ—‘";
        deleteBtn.title = "ì‚­ì œ";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteNote(note.id);
        });

        actionsDiv.appendChild(pinBtn);
        actionsDiv.appendChild(deleteBtn);

        li.appendChild(main);
        li.appendChild(actionsDiv);

        noteListEl.appendChild(li);
      });
    }

    // ===== í•€ / ì‚­ì œ =====
    function togglePin(id) {
      const idx = notes.findIndex(n => n.id === id);
      if (idx === -1) return;
      notes[idx].pinned = !notes[idx].pinned;
      notes[idx].updatedAt = Date.now();
      saveNotes();
      renderNotes();
    }

    function deleteNote(id) {
      if (!confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      notes = notes.filter(n => n.id !== id);
      saveNotes();
      renderNotes();
      if (String(id) === noteIdInput.value) {
        clearForm();
      }
    }

    // ===== í¼ ì±„ìš°ê¸° / ì´ˆê¸°í™” =====
    function clearForm() {
      noteIdInput.value = "";
      titleInput.value = "";
      contentInput.value = "";
      emojiSelect.value = "ğŸ”¥";
      emojiPreview.textContent = "ğŸ”¥";
      alarmAtInput.value = "";
      draftInfo.textContent = "ìë™ì €ì¥ ëŒ€ê¸° ì¤‘...";
      updateCountInfo();
    }

    function loadNoteIntoForm(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;
      noteIdInput.value = String(note.id);
      titleInput.value = note.title || "";
      contentInput.value = note.content || "";
      emojiSelect.value = note.emoji || "ğŸ”¥";
      emojiPreview.textContent = emojiSelect.value;
      updateCountInfo();
      if (note.alarmAt) {
        const d = new Date(note.alarmAt);
        if (!Number.isNaN(d.getTime())) {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          const h = String(d.getHours()).padStart(2, "0");
          const min = String(d.getMinutes()).padStart(2, "0");
          alarmAtInput.value = `${y}-${m}-${day}T${h}:${min}`;
        }
      } else {
        alarmAtInput.value = "";
      }
      draftInfo.textContent = "ê¸°ì¡´ ë©”ëª¨ í¸ì§‘ ì¤‘ (ìë™ì €ì¥ í™œì„±í™”)";
    }

    // ===== ë©”ëª¨ ì €ì¥ / ì—…ë°ì´íŠ¸ =====
    function handleSave() {
      const title = titleInput.value.trim() || "ì œëª© ì—†ìŒ";
      const content = contentInput.value.trim();
      const emoji = emojiSelect.value || "ğŸ’ª";
      const alarmValue = alarmAtInput.value;

      if (!content) {
        alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      let alarmAt = "";
      let alarmDone = false;
      if (alarmValue) {
        const d = new Date(alarmValue);
        if (!Number.isNaN(d.getTime())) {
          alarmAt = d.toISOString();
          if (d <= new Date()) {
            alarmDone = true;
          }
        }
      }

      const now = Date.now();
      const idStr = noteIdInput.value;
      if (idStr) {
        const id = Number(idStr);
        const idx = notes.findIndex(n => n.id === id);
        if (idx !== -1) {
          const note = notes[idx];
          note.title = title;
          note.content = content;
          note.emoji = emoji;
          note.updatedAt = now;
          note.alarmAt = alarmAt;
          if (alarmAt) {
            const alarmTime = new Date(alarmAt);
            note.alarmDone = alarmTime <= new Date();
          } else {
            note.alarmDone = false;
          }
        }
      } else {
        const newNote = {
          id: now,
          title,
          content,
          emoji,
          createdAt: now,
          updatedAt: now,
          pinned: false,
          alarmAt,
          alarmDone
        };
        notes.push(newNote);
        noteIdInput.value = String(newNote.id);
      }

      saveNotes();
      clearDraft();
      draftInfo.textContent = "ì €ì¥ ì™„ë£Œ! (ë‹¤ì‹œ ìˆ˜ì • ì‹œ ìë™ì €ì¥ë©ë‹ˆë‹¤)";
      renderNotes();
      startAlarmWatcher();
    }

    saveBtn.addEventListener("click", handleSave);

    // Ctrl + S ë¡œ ì €ì¥
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && (e.key === "s" || e.key === "S")) {
        e.preventDefault();
        handleSave();
      }
    });

    newBtn.addEventListener("click", () => {
      clearForm();
      clearDraft();
    });

    // ===== í…œí”Œë¦¿ ë²„íŠ¼ =====
    function applyTemplate(type) {
      if (type === "plan") {
        titleInput.value = "ì˜¤ëŠ˜ì˜ ê³„íš";
        contentInput.value =
          "- ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼\n" +
          "  1) \n  2) \n  3) \n\n" +
          "- ê¼­ ì§€í‚¤ê³  ì‹¶ì€ í•œ ê°€ì§€ ë‹¤ì§:\n";
      } else if (type === "workout") {
        titleInput.value = "ìš´ë™ ê¸°ë¡";
        contentInput.value =
          "ìš´ë™ ë‚ ì§œ: " + new Date().toLocaleDateString() + "\n\n" +
          "ìš´ë™ ë‚´ìš©\n" +
          "- ì¤€ë¹„ìš´ë™:\n" +
          "- ë©”ì¸ ìš´ë™:\n" +
          "- ë§ˆë¬´ë¦¬ ìŠ¤íŠ¸ë ˆì¹­:\n\n" +
          "ì˜¤ëŠ˜ ìš´ë™ ì†Œê°:\n";
      } else if (type === "thanks") {
        titleInput.value = "ê°ì‚¬ ì¼ê¸°";
        contentInput.value =
          "ì˜¤ëŠ˜ ê°ì‚¬í•œ ì¼ 3ê°€ì§€\n" +
          "1)\n2)\n3)\n\n" +
          "ì˜¤ëŠ˜ ë‚˜ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ ë§:\n";
      }
      updateCountInfo();
      scheduleDraftSave();
    }

    templateChips.forEach(chip => {
      chip.addEventListener("click", () => {
        const type = chip.dataset.template;
        applyTemplate(type);
      });
    });

    // ===== ê²€ìƒ‰ & í•€ í•„í„° =====
    searchInput.addEventListener("input", renderNotes);
    pinnedFilterBtn.addEventListener("click", () => {
      showPinnedOnly = !showPinnedOnly;
      pinnedFilterBtn.classList.toggle("active", showPinnedOnly);
      renderNotes();
    });

    // ===== ì´ëª¨ì§€ ë¯¸ë¦¬ë³´ê¸° =====
    emojiSelect.addEventListener("change", () => {
      emojiPreview.textContent = emojiSelect.value;
      scheduleDraftSave();
    });

    // ===== ì•ŒëŒ ê¸°ëŠ¥ =====
    function showAlarm(note) {
      alert(`â° [ì•ŒëŒ] ${note.emoji || "ğŸ’ª"} ${note.title}\n\n${(note.content || "").slice(0, 120)}`);
    }

    function checkAlarms() {
      const now = new Date();
      let changed = false;
      notes.forEach(n => {
        if (!n.alarmAt || n.alarmDone) return;
        const alarmTime = new Date(n.alarmAt);
        if (Number.isNaN(alarmTime.getTime())) return;
        if (now >= alarmTime) {
          n.alarmDone = true;
          changed = true;
          showAlarm(n);
        }
      });
      if (changed) {
        saveNotes();
        renderNotes();
      }
    }

    function startAlarmWatcher() {
      if (alarmTimer) clearInterval(alarmTimer);
      alarmTimer = setInterval(checkAlarms, 15000);
    }

    // ===== ìë™ì €ì¥(ì„ì‹œì €ì¥) =====
    function loadDraft() {
      const raw = localStorage.getItem(DRAFT_KEY);
      return raw ? JSON.parse(raw) : null;
    }

    function saveDraft(data) {
      localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
    }

    function clearDraft() {
      localStorage.removeItem(DRAFT_KEY);
    }

    const DRAFT_DELAY = 800;

    function scheduleDraftSave() {
      if (draftTimer) clearTimeout(draftTimer);
      draftInfo.textContent = "ì…ë ¥ ì¤‘... ìë™ì €ì¥ ì¤€ë¹„ ì¤‘";

      draftTimer = setTimeout(() => {
        const draft = {
          id: noteIdInput.value ? Number(noteIdInput.value) : null,
          title: titleInput.value,
          content: contentInput.value,
          emoji: emojiSelect.value,
          alarmAt: alarmAtInput.value
        };
        saveDraft(draft);
        draftInfo.textContent = "ì„ì‹œì €ì¥ ì™„ë£Œ";
      }, DRAFT_DELAY);
    }

    [titleInput, contentInput, alarmAtInput].forEach(el =>
      el.addEventListener("input", scheduleDraftSave)
    );
    emojiSelect.addEventListener("change", scheduleDraftSave);

    function restoreDraftIfExists() {
      const draft = loadDraft();
      if (!draft) {
        draftInfo.textContent = "ìë™ì €ì¥ ëŒ€ê¸° ì¤‘...";
        return;
      }
      if (draft.id) {
        const note = notes.find(n => n.id === draft.id);
        if (note) {
          noteIdInput.value = String(draft.id);
        }
      }
      titleInput.value = draft.title || "";
      contentInput.value = draft.content || "";
      emojiSelect.value = draft.emoji || "ğŸ”¥";
      emojiPreview.textContent = emojiSelect.value;
      alarmAtInput.value = draft.alarmAt || "";
      draftInfo.textContent = "ì´ì „ì— ì‘ì„± ì¤‘ì´ë˜ ë©”ëª¨ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.";
      updateCountInfo();
    }

    // ===== ì´ˆê¸° ì‹¤í–‰ =====
    (function init() {
      loadTheme();
      loadStyle();
      loadNotes();
      updateCountInfo();
      renderNotes();
      restoreDraftIfExists();
      startAlarmWatcher();
    })();
  </script>
</body>
</html>
